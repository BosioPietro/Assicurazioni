<header class="flex-row">
  <div class="flex-col">
    <h1>Utenti</h1>
    <p>Visualizza e modifica utenti</p>
  </div>
  <div class="flex-row">
    <button (click)="EsportaCSV()">
      <ion-icon name="arrow-down"></ion-icon>
      <span>Esporta CSV</span>
    </button>
    <button class="accento" >
      <ion-icon name="add"></ion-icon>
      <span>Nuovo utente</span>
    </button>
  </div>
</header>
<main class="flex-row">
  <div class="padding"></div>
  <div class="wrapper flex-col">
    <div class="cont-carte flex-row">
      <div class="angolo"></div>
      <div class="angolo"></div>
      <div class="angolo"></div>
      <div class="angolo"></div>
      <div class="carta">
        <p>Perizie in corso</p>
        <h1>
          <span>123</span>
          <ion-icon name="arrow-up"></ion-icon>
        </h1>
      </div>
      <div class="carta">
        <p>Perizie completate oggi</p>
        <h1>
          <span>123</span>
          <ion-icon name="arrow-down"></ion-icon>
        </h1>
      </div>
      <div class="carta">
        <p>Dipendenti totali</p>
        <h1>
          <span>123</span>
          <ion-icon name="arrow-up"></ion-icon>
        </h1>
      </div>
      <div class="carta">
        <p>Dipendenti attivi oggi</p>
        <h1>
          <span>123</span>
          <ion-icon name="arrow-up"></ion-icon>
        </h1>
      </div>
    </div>
    <div class="cont-utenti flex-col">
      <hr/>
      <h1>Dipendenti</h1>
      <div class="flex-row">
        <div class="flex-row">
          <BottoniOpzione (onChange)="CambiaMod($event)" [opzioni]="opzioniDipendenti"/>
          @if (tabella.selezionati.length) {
            <div class="wrapper-menu flex-row jc-c">
                <p-menu #menu 
                  [model]="[opzioneElimina, tabella.selezionati.length == 1 ? opzioneCreaChat : opzioneCreaGruppo]" 
                  [popup]="true" 
                  appendTo="body">
                </p-menu>
                <button type="button" (click)="menu.toggle($event)" class="flex-row al-c" [@appari]>
                  <ion-icon name="ellipsis-horizontal"></ion-icon>
                </button>
            </div>
          }
        </div>
        <BarraRicerca (onCerca)="tabella.nome = $event"/>
      </div>
      <TabellaUtenti (utenteSelezionato)="MostraPannelloUtente()"/>
    </div>
  </div>
  <div class="padding"></div>
</main>
<footer></footer>

<dialog #modaleElimina  id="dialogoElimina">
  <div class="flex-col al-c jc-c">
    <ion-icon name="alert-circle"></ion-icon>
    <span>
      <h1>Elimina Utent{{ tabella.selezionati.length > 1 ? 'i' : 'e' }}</h1>
      <p>
        Stai per eliminare {{tabella.selezionati.length > 1 ? tabella.selezionati.length : 'un'  }} utent{{ tabella.selezionati.length > 1 ? 'i' : 'e' }},<br>
        questa azione è irreversibile.
      </p>
    </span>
    <div class="flex-row jc-c">
      <button (click)="EliminaUtenti()" class="elimina">Elimina</button>
      <button (click)="ChiudiModale(modaleElimina)">Annulla</button>
    </div>
  </div>
</dialog>

@if(tabella.utenteVisualizzato && tabella.utenteModificato){
  <dialog #modaleUtente id="dialogoModifica" class="flex-row">
    <div class="nav-dialogo flex-col">
      <button class="opzione selezionata flex-row">
        <ion-icon name="person-circle"></ion-icon>
        <span>Informazioni Personali</span>
      </button>
      <button class="opzione flex-row">
        <ion-icon name="file-tray-full"></ion-icon>
        <span>Perizie</span>
      </button>
    </div>
    <div class="pagina-dialogo">
      <h1>Modifica utente</h1>
      <div class="wrapper flex-col">
        <div class="flex-row">
          @if (tabella.utenteModificato.pfp) {
            <img [src]="tabella.utenteModificato.pfp" class="immagine-utente">
          }
          @else {
            <ImmagineProfileDefault [nome]="tabella.utenteModificato.cognome" class="immagine-utente"/>
          }
          <div class="flex-col cambia-immagine jc-c">
            <button>
              {{ tabella.utenteModificato.pfp ? 'Modifica immagine' : 'Aggiungi immagine' }}
            </button>
            <p>
              È consigliato utilizzare un'immagine quadrata di almeno 200x200 pixel.<br>
              I formati supportati sono JPG e PNG.
            </p>
          </div>
        </div>
        <hr/>
        <div class="info-utente sopra">
          <div class="flex-row header-info">
            <h3>Informazioni personali</h3>
            @if(infoPersonali.modifica)
            {
              <div class="flex-row row-bottoni">
                <button (click)="ResettaInfoPersonali()">
                  <ion-icon name="close"></ion-icon>
                  <span>Annulla</span>
                </button>
                <button class="accento" [disabled]="!infoPersonali.valide || infoPersonali.uguali">
                  <ion-icon name="checkmark"></ion-icon>
                  <span>Applica</span>
                  <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                </button>
              </div>
            }
            @else {
            <button (click)="infoPersonali.modifica = true">
              <i class="pi pi-pencil"></i>
              <span>Modifica</span>
            </button>
            }
          </div>
          <form class="cont-utente">
            <InputText 
              icona="person" 
              name="info-nome"
              id-input="info-nome"
              testo-label="Nome" 
              [messaggio-errore]="infoPersonali.errori['info-nome']"
              [mockup]="!infoPersonali.modifica" 
              [(ngModel)]="tabella.utenteModificato.nome"
              (onChange)="VerificaInputPersonali($event)"
              (onKeyDown)="infoPersonali.errori['info-nome']=''; ControllaErroriPersonali()"
            />
            <InputText 
              icona="person" 
              name="info-cognome"
              id-input="info-cognome"
              testo-label="Cognome" 
              [messaggio-errore]="infoPersonali.errori['info-cognome']"
              [mockup]="!infoPersonali.modifica" 
              [(ngModel)]="tabella.utenteModificato.cognome"
              (onChange)="VerificaInputPersonali($event)"
              (onKeyDown)="infoPersonali.errori['info-cognome']=''; ControllaErroriPersonali()"
            />
            <InputText 
              icona="at" 
              name="info-username"
              id-input="info-username"
              testo-label="Username" 
              [messaggio-errore]="infoPersonali.errori['info-username']"
              [mockup]="!infoPersonali.modifica" 
              [(ngModel)]="tabella.utenteModificato.username"
              (onChange)="VerificaInputPersonali($event)"
              (onKeyDown)="infoPersonali.errori['info-username']=''; ControllaErroriPersonali()"
            />
            <InputText 
              icona="mail" 
              name="info-mail"
              id-input="info-mail"
              testo-label="E-Mail" 
              [messaggio-errore]="infoPersonali.errori['info-mail']"
              [mockup]="!infoPersonali.modifica" 
              [(ngModel)]="tabella.utenteModificato.email"
              (onChange)="VerificaInputPersonali($event)"
              (onKeyDown)="infoPersonali.errori['info-mail']=''; ControllaErroriPersonali()"
            />
            <InputText 
              icona="call" 
              name="info-telefono"
              id-input="info-telefono"
              testo-label="Telefono" 
              [messaggio-errore]="infoPersonali.errori['info-telefono']"
              [mockup]="!infoPersonali.modifica" 
              [(ngModel)]="tabella.utenteModificato.telefono"
              (onChange)="VerificaInputPersonali($event)"
              (onKeyDown)="infoPersonali.errori['info-telefono']=''; ControllaErroriPersonali()"
            />
            <Dropdown 
              testo-label="2FA Abilitato"
              name="info-2FA"
              id-input="info-2FA"
              icona="lock-closed" 
              [mockup]="!infoPersonali.modifica" 
              [disabilitato]="!regexInput['telefono'].test(tabella.utenteModificato['telefono'])" 
              [opzioni]="opzioniSiNo"
              [(ngModel)]="tabella.utenteModificato['2FA']"
              (onChange)="VerificaInputPersonali($event)"
              (onInput)="infoPersonali.errori['info-2FA']=''; ControllaErroriPersonali()"
            />
          </form>
        </div>
        <form class="info-utente">
          <div class="flex-row header-info">
            <h3>Informazioni lavoro</h3>
            @if(infoLavoro.modifica)
            {
              <div class="flex-row row-bottoni">
                <button (click)="ResettaInfoLavoro()">
                  <ion-icon name="close"></ion-icon>
                  <span>Annulla</span>
                </button>
                <button class="accento" [disabled]="infoLavoro.uguali">
                  <ion-icon name="checkmark"></ion-icon>
                  <span>Applica</span>
                </button>
              </div>
            }
            @else {
            <button (click)="infoLavoro.modifica = true">
              <i class="pi pi-pencil"></i>
              <span>Modifica</span>
            </button>
            }
          </div>
          <div class="cont-utente">
            <Dropdown 
              testo-label="Ruolo" 
              icona="briefcase"
              name="lavoro-ruolo"
              id-input="lavoro-ruolo"
              [opzioni]="opzioniRuolo" 
              [mockup]="!infoLavoro.modifica" 
              [(ngModel)]="tabella.utenteModificato.ruolo"
              (ngModelChange)="ControllaUgualiLavoro()"
            />
            <p-calendar 
              [(ngModel)]="tabella.utenteModificato.assuntoIl" dateFormat="yy-mm-dd"
              name="lavoro-assuntoIl"
              [firstDayOfWeek]="1"
              [iconDisplay]="'input'" 
              [showIcon]="true"
              [disabled]="!infoLavoro.modifica"
              (onInput)="ControllaUgualiLavoro()"
            >
            </p-calendar>
            <Dropdown 
              testo-label="Attivo"
              icona="accessibility" 
              name="lavoro-attivo"
              id-input="lavoro-attivo"
              [mockup]="!infoLavoro.modifica"   
              [opzioni]="opzioniSiNo" 
              [(ngModel)]="tabella.utenteModificato.attivo"
              (ngModelChange)="ControllaUgualiLavoro()"
            />
            <InputText icona="file-tray-full" testo-label="Perizie attive" [mockup]="true" valore="1"/>
          </div>
        </form>
      </div>
    </div>
  </dialog>
}